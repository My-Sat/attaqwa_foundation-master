extends layout

mixin commentItem(comment, postId)
  li.community-comment-item.mb-2(data-comment-id=comment.id)
    div
      strong= comment.authorName
    p.mb-1= comment.body
    .d-flex.align-items-center.gap-2.mb-1
      button.btn.btn-sm.btn-outline-primary.community-like-btn(
        type="button"
        data-action="like-comment"
        data-post-id=postId
        data-comment-id=comment.id
        class=(comment.likedByCurrent ? 'is-liked' : '')
        data-no-loading
      ) #{comment.likedByCurrent ? 'Liked' : 'Like'}
      small.text-muted.community-like-count(data-comment-like-count)= (typeof comment.likesCount === 'number' ? comment.likesCount : 0)
    small.text-muted= new Date(comment.createdAt).toLocaleString()
    if isLoggedIn
      .mt-2
        button.btn.btn-sm.btn-outline-secondary.community-reply-toggle(type="button" data-action="toggle-reply") Reply
      form.community-comment-form.community-reply-form.mt-2.d-none(data-post-id=postId data-parent-comment-id=comment.id)
        .input-group
          input.form-control.auth-input(type="text" name="body" maxlength="700" placeholder="Write a reply..." required)
          button.btn.btn-outline-primary(type="submit") Reply
    if comment.replies && comment.replies.length
      button.btn.btn-sm.btn-outline-secondary.community-replies-toggle.mt-2(
        type="button"
        data-action="toggle-replies"
        data-replies-count=comment.replies.length
      ) View replies (#{comment.replies.length})
      ul.community-replies.list-unstyled.mt-2.d-none
        each reply in comment.replies
          +commentItem(reply, postId)

block content
  section.home-hero
    .hero-content
      h1.hero-title At-Taqwa Foundation
      p.hero-subtitle The gateway to taqwa through live teaching, practical resources, and trusted answers.
      .hero-actions
        a.btn.btn-donate(href="/donate") Donate Now

  section.home-grid
    .row.g-4
      .col-12.col-lg-8
        .panel.live-panel
          .panel-header
            h2 Live Stream
            p#liveStreamNote.live-stream-note(
              data-note=(liveStreamSchedule && liveStreamSchedule.note ? liveStreamSchedule.note : '')
            )
          p#liveStreamCountdown.countdown-text(
            data-start-at=(liveStreamSchedule && liveStreamSchedule.startsAt ? liveStreamSchedule.startsAt.toISOString() : '')
          ) No incoming live video for the moment
          .iframe-container
            iframe(
              src=liveVideoUrl
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
              title="Live stream player"
            )

      .col-12.col-lg-4
        .panel.ask-panel
          a.btn.btn-live-class(href="/live_class")
            i.fas.fa-broadcast-tower.me-2
            | Join Live Class
          .ask-brand
            img.sheesu(src="/images/sheesu.jpg" alt="Sheesu")
            a.btn.btn-ask(href="/ask_sheesu") Ask Shiisu
          h3.panel-section-title Recent Questions and Answers
          ul.question-list.list.home-lazy-list(
            data-feed-type="questions"
            data-page-size=homePageSize
            data-initial-count=questions.length
            data-has-more=(hasMoreQuestions ? 'true' : 'false')
            data-load-mode="button"
          )
            if questions.length
              each question in questions
                li
                  a(href=`/question/${question._id}`) #{question.question}
            else
              li.text-muted.home-empty-state No answered questions yet.
            li.home-view-more-row(class=(hasMoreQuestions ? '' : 'd-none'))
              button.home-view-more-btn.btn.btn-outline-secondary.btn-sm(type="button" data-no-loading) View more
            li.home-list-loader.text-muted(style="display:none;") Loading...
            li.home-list-sentinel(aria-hidden="true")

    .row.g-4.mt-1
      .col-12.col-lg-6
        .panel.resources-panel
          h3.panel-section-title Videos
          ul.video-list.list.home-lazy-list(
            data-feed-type="videos"
            data-page-size=homePageSize
            data-initial-count=videoCategories.length
            data-has-more=(hasMoreVideos ? 'true' : 'false')
          )
            if videoCategories.length
              each category in videoCategories
                li
                  a(href=category.url) #{category.title}
            else
              li.text-muted.home-empty-state No video categories available.
            li.home-list-loader.text-muted(style="display:none;") Loading...
            li.home-list-sentinel(aria-hidden="true")

      .col-12.col-lg-6
        .panel.resources-panel
          h3.panel-section-title Articles and Curricular
          ul.article-list.list.home-lazy-list(
            data-feed-type="articles"
            data-page-size=homePageSize
            data-initial-count=articles.length
            data-has-more=(hasMoreArticles ? 'true' : 'false')
          )
            if articles.length
              each article in articles
                li
                  a(href=`/article/${article._id}`) #{article.title}
            else
              li.text-muted.home-empty-state No articles available.
            li.home-list-loader.text-muted(style="display:none;") Loading...
            li.home-list-sentinel(aria-hidden="true")

    .row.mt-4
      .col-12
        .visitors-bottom
          span Visitors
          strong= visitorCount

    .row.g-4.mt-2
      .col-12
        .panel.community-panel
          .panel-header
            h3.panel-section-title.mb-0 Community Posts
          p.text-muted.mb-3 Share insights and engage with other learners.

          if isLoggedIn
            form#postComposer.community-composer.mb-3
              .mb-2
                textarea#postBody.form-control.auth-input(name="body" rows="3" maxlength="1200" placeholder="Share something helpful..." required)
              .d-flex.justify-content-between.align-items-center.gap-2
                small.text-muted#postComposerHint Max 1200 characters.
                button.btn.admin-btn(type="submit") Post
          else
            .alert.alert-info.py-2.px-3.mb-3
              | Sign in to post and comment.
              a.ms-1(href="/signin") Sign in

          p#communityFeedback.admin-feedback.d-none

          .community-posts#communityPosts(
            data-page-size=postPageSize
            data-initial-count=posts.length
            data-has-more=(hasMorePosts ? 'true' : 'false')
            data-is-logged-in=(isLoggedIn ? 'true' : 'false')
          )
            if posts && posts.length
              each post in posts
                article.community-post.card.mb-3(data-post-id=post.id)
                  .card-body
                    .d-flex.justify-content-between.align-items-start.gap-2.mb-2
                      div
                        strong.community-author= post.authorName
                      small.text-muted= new Date(post.createdAt).toLocaleString()
                    p.community-body.mb-3= post.body
                    .d-flex.align-items-center.gap-2.mb-3
                      button.btn.btn-sm.btn-outline-primary.community-like-btn(
                        type="button"
                        data-action="like-post"
                        data-post-id=post.id
                        class=(post.likedByCurrent ? 'is-liked' : '')
                        data-no-loading
                      ) #{post.likedByCurrent ? 'Liked' : 'Like'}
                      small.text-muted.community-like-count(data-post-like-count)= (typeof post.likesCount === 'number' ? post.likesCount : 0)
                    .community-comments-wrap
                      h6.community-comment-title.mb-2 Comments (#{post.commentsCount || 0})
                      ul.community-comments.list-unstyled.mb-2
                        if post.comments && post.comments.length
                          each comment in post.comments
                            +commentItem(comment, post.id)
                        else
                          li.text-muted.small.community-no-comments No comments yet.

                      if isLoggedIn
                        form.community-comment-form(data-post-id=post.id)
                          .input-group
                            input.form-control.auth-input(type="text" name="body" maxlength="700" placeholder="Write a comment..." required)
                            button.btn.btn-outline-primary(type="submit") Comment
            else
              p.text-muted.mb-0#communityEmptyState No posts yet. Be the first to post.

          .d-flex.justify-content-center.mt-2
            button#loadMorePostsBtn.btn.btn-outline-secondary.btn-sm(type="button" class=(hasMorePosts ? '' : 'd-none') data-no-loading) View more posts

  if liveClassNotice
    .modal.fade#liveClassNoticeModal(tabindex="-1" aria-labelledby="liveClassNoticeModalLabel" aria-hidden="true")
      .modal-dialog
        .modal-content
          .modal-header
            h5#liveClassNoticeModalLabel.modal-title Live Class Notice
            button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
          .modal-body
            p.mb-0= liveClassNotice
          .modal-footer
            button.btn.admin-btn(type="button" data-bs-dismiss="modal") Okay

block scripts
  script(src="/javascripts/homeLazyLists.js")
  script(src="/javascripts/homeCountdown.js")
  script(src="/javascripts/homePosts.js")
  if liveClassNotice
    script.
      (function () {
        const showNoticeModal = function () {
          const modalElement = document.getElementById('liveClassNoticeModal');
          if (!modalElement) {
            return;
          }

          if (window.bootstrap && window.bootstrap.Modal) {
            const noticeModal = window.bootstrap.Modal.getOrCreateInstance(modalElement);
            noticeModal.show();
            return;
          }

          window.alert("#{liveClassNotice}");
        };

        if (document.readyState === 'complete') {
          showNoticeModal();
          return;
        }

        window.addEventListener('load', showNoticeModal, { once: true });
      })();
