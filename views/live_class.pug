extends layout

block content
  .container.py-3
    .row.justify-content-center
      .col-12
        h3.text-center Live Class
        if classSession && classSession.title
          p.text-center.text-muted.mb-1 Session: #{classSession.title}
        if liveStartedAt
          p.text-center.text-muted.mb-1 Started: #{new Date(liveStartedAt).toLocaleString()}
        if accessExpiresAt
          p.text-center.text-muted Access valid until #{new Date(accessExpiresAt).toLocaleString()}
        .d-flex.justify-content-center.mb-3
          a.btn.btn-outline-secondary(href="/") Exit Class

    .row.justify-content-center
      .col-12
        // Jitsi meeting container
        #jaas-container(style="width: 100%; height: 500px;")

  script(src="https://8x8.vc/vpaas-magic-cookie-7614453dbd0f4854940c861ddc93636a/external_api.js" async)

  script.
    window.onload = () => {
      const roomName = "vpaas-magic-cookie-7614453dbd0f4854940c861ddc93636a/#{roomName}";
      const api = new JitsiMeetExternalAPI("8x8.vc", {
        roomName,
        parentNode: document.querySelector('#jaas-container'),
        userInfo: {
          displayName: "#{attendeeName}"
        },
        configOverwrite: {
          prejoinConfig: {
            enabled: false
          },
          disableModeratorIndicator: true
        }
      });

      const pollLiveStatus = async () => {
        try {
          const response = await fetch('/api/live-class/status', {
            credentials: 'same-origin'
          });
          const payload = await response.json();

          if (!payload.isLive || payload.roomName !== "#{roomName}") {
            alert('Class has ended by admin.');
            window.location.href = '/';
          }
        } catch (error) {
          // Keep session alive even if a single poll fails
        }
      };

      window.setInterval(pollLiveStatus, 20000);
    }
